<VirtualHost *:80>
  ServerName dev.foxx.pet
  RewriteEngine On
  RewriteRule ^ https://dev.foxx.pet%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
  ServerName dev.foxx.pet
  DocumentRoot /var/www/dev.foxx.pet/public

  # --- SSL ---
  SSLEngine on
  Include /etc/letsencrypt/options-ssl-apache.conf
  SSLCertificateFile /etc/letsencrypt/live/foxx.pet-0001/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/foxx.pet-0001/privkey.pem
  # (Achte darauf, dass das Zertifikat SAN für dev.foxx.pet enthält.)

  # --- Proxy / Vite HMR ---
  ProxyPreserveHost On
  ProxyRequests Off
  RequestHeader set X-Forwarded-Proto "https"

  # WebSocket-Upgrade für HMR
  RewriteEngine On
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteRule ^/(.*)$ ws://127.0.0.1:4321/$1 [P,L]

  # Haupt-Proxy zum Astro-Dev-Server
  ProxyPass        / http://127.0.0.1:4321/ retry=0
  ProxyPassReverse / http://127.0.0.1:4321/

  # Eigene ErrorPages statt Upstream-Fehlern verwenden
  ProxyErrorOverride On
  ErrorDocument 502 /index.html
  ErrorDocument 503 /index.html

  # --- Fallback-DocRoot (wenn Dev-Server down ist) ---
  <Directory /var/www/dev.foxx.pet/public>
    Options -Indexes
    AllowOverride All
    Require all granted
  </Directory>

  # --- Security / CSP (dev: HMR erlauben) ---
  Header set Content-Security-Policy "default-src 'self'; img-src 'self' https://i.foxx.pet https://img.foxx.pet https://stats.foxx.pet data: blob:; media-src 'self' https://i.foxx.pet https://img.foxx.pet; connect-src 'self' wss://dev.foxx.pet https://i.foxx.pet https://img.foxx.pet https://stats.foxx.pet; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; frame-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; object-src 'none'; base-uri 'self'; frame-ancestors 'none'"

  Header always set X-Robots-Tag "noindex, nofollow"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"

  # --- Logging ---
  ErrorLog  ${APACHE_LOG_DIR}/dev.foxx.pet.error.log
  CustomLog ${APACHE_LOG_DIR}/dev.foxx.pet.access.log combined
</VirtualHost>
