---
import { registry  } from '@Assets/icons.registry';

type IconName = keyof typeof registry;
type IconIdentifier = IconName | (string & {});

export interface Props {
  /**
   * Preferred property for selecting an icon. Use `kind` for backwards compatibility.
   */
  name?: IconIdentifier;
  /**
   * Legacy property retained so older usages keep working.
   */
  kind?: IconIdentifier;
  class?: string
  size?: string
  title?: string
  stroke?: boolean
  strokeWidth?: number
}

const fallbackIcon = (missing: string) => ({
  vb: '0 0 24 24',
  body: '<path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 15.25a1.25 1.25 0 1 1 1.25-1.25A1.25 1.25 0 0 1 12 17.25Zm1.22-6.22-.82.74v1.48h-1.52V11.2l1.4-1.26a1.87 1.87 0 0 0 .66-1.42c0-.98-.77-1.77-1.72-1.77s-1.71.79-1.71 1.77H8.6a3.4 3.4 0 0 1 3.62-3.32c1.91 0 3.47 1.42 3.47 3.3a3.12 3.12 0 0 1-1.47 2.44Z"/>',
  attrs: { 'data-icon-missing': missing },
});

const {
  name: propName,
  kind,
  class: cls = '', size = '1em', title,
  stroke = false, strokeWidth = 1.5,
} = Astro.props;

const iconName = propName ?? kind;
if (!iconName) {
  throw new Error('Missing icon identifier. Provide a `name` (preferred) or `kind` prop.');
}

const isKnownIcon = (value: string): value is IconName => value in registry;

type IconDefinition = (typeof registry)[IconName];
type ResolvedIcon = IconDefinition | ReturnType<typeof fallbackIcon>;

let icon: ResolvedIcon;
if (typeof iconName === 'string' && isKnownIcon(iconName)) {
  icon = registry[iconName];
} else {
  console.warn(`Unknown icon: ${iconName}`);
  icon = fallbackIcon(String(iconName));
}

const { vb, body = {} } = icon;
const labelled = !!title;
---

<svg
  class={cls}
  width={size} height={size}
  viewBox={vb}
  preserveAspectRatio="xMidYMid meet"
  fill={stroke ? 'none' : 'currentColor'}
  stroke={stroke ? 'currentColor' : 'none'}
  stroke-width={stroke ? strokeWidth : undefined}
  stroke-linecap={stroke ? 'round' : undefined}
  stroke-linejoin={stroke ? 'round' : undefined}
  aria-hidden={labelled ? 'false' : 'true'}
  role="img"
  focusable="false"
>
  {title ? <title>{title}</title> : null}
  {typeof body === 'string' ? <Fragment set:html={body} /> : body}
</svg>

<style>
.icon{
  display:inline-block;
  inline-size:1em;
  block-size:1em;
  vertical-align:-0.125em; /* optischer Ausgleich wie bei Fonts */
}
</style>
