---
import { Template } from '@Frontend';
import { PLACEHOLDER_COVER } from '@Assets/covers';
import { getEntriesBySectionAndCategory } from '@utils/getEntries';
import { getSectionBaseHref, loadSectionContext } from '@utils/sectionContext';
import { createBlogEntryView, matchesEntrySlug } from '@utils/entryTransforms';
import type { CollectionEntry } from 'astro:content';

const placeholderCover = PLACEHOLDER_COVER.src;

// → hier stellst du ein, welchen Blog-Eintrag du auf der Testseite sehen willst
const section = 'tails';
const categorySlug='lucys-journeys';
const slug = 'tails-lucys-journeys-starlit-liftoff';

const {
  sectionSlug,
  page: parentPage,
  category,
  error: contextError,
} = await loadSectionContext({
  url: Astro.url,
  section,
  kind: 'entry',
  missingSectionMessage: 'We could not resolve this page — please try again later.',
});

let errorMessage = contextError;

const targetCategory = categorySlug ?? slug;

const entries = !errorMessage
  ? await getEntriesBySectionAndCategory(sectionSlug, targetCategory)
  : [];

const entry = entries.find((candidate) => matchesEntrySlug(candidate, slug));

let blogView: ReturnType<typeof createBlogEntryView>['blog'] | undefined;
let BlogContent: Awaited<
  ReturnType<CollectionEntry<'blog'>['render']>
>['Content'] | undefined;

if (!entry && !errorMessage) {
  errorMessage = 'We could not find that entry yet. Please check back soon!';
}

if (!errorMessage && entry) {
  const parentHref = getSectionBaseHref(sectionSlug, parentPage);

  const rendered = await entry.render();
  BlogContent = rendered.Content;

  const blogData = createBlogEntryView(entry, parentHref, {
    categorySlug,
    categoryDescription: category?.description,
    parentPage,
    placeholderCover,
  });

  blogView = blogData.blog;
}
---

<Template.Base title="Entry layout test">
  {errorMessage ? (
    <section class="content-section">
      <Template.Card class="card--center">
        <Fragment slot="body">
          <p>{errorMessage}</p>
        </Fragment>
      </Template.Card>
    </section>
  ) : blogView && BlogContent ? (
    <Template.EntryBlog
      blog={{
        title: blogView.title,
        description: blogView.description,
        introParagraphs: blogView.introParagraphs,
        cover: blogView.cover,
        chapters: blogView.chapters,
        // optional, aber dann stimmen Datum/Badge auch:
        category: blogView.category,
        date: blogView.date,
      }}
      BlogContent={BlogContent}
    />
  ) : null}
</Template.Base>
