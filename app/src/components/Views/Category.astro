---
import { Template } from '@Frontend';
import { PLACEHOLDER_COVER } from '@Assets/covers';
import { getIntroParagraphs, getNavLabelParts } from '@Content/siteContent';
import { getEntriesBySectionAndCategory } from '@utils/getEntries';
import { getSectionBaseHref, loadSectionContext } from '@utils/sectionContext';
import { normalizeEntriesForTile } from '@utils/entryTransforms';

interface Props {
  slug: string;
  section?: string;
}

const { slug, section } = Astro.props as Props;

const { sectionSlug, page: parentPage, category, error: contextError } = await loadSectionContext({
  url: Astro.url,
  section,
  categorySlug: slug,
  kind: 'category',
  missingSectionMessage: 'We could not resolve the requested collection.',
});

let errorMessage = contextError;

if (!errorMessage && !category) {
  errorMessage = 'There is nothing in this section yet — please check back later!';
}

const entries = !errorMessage
  ? await getEntriesBySectionAndCategory(sectionSlug, slug)
  : [];

const placeholderCover = PLACEHOLDER_COVER.src;
const parentHref = getSectionBaseHref(sectionSlug, parentPage);

const normalizedEntries = !errorMessage
  ? normalizeEntriesForTile(entries, {
      parentHref,
      defaultCategorySlug: slug,
      placeholderCover,
    })
  : [];

const hasEntries = normalizedEntries.length > 0;

const pageTitle = category?.title ?? parentPage?.title ?? 'Coming soon';
const pageDescription = category?.description ?? parentPage?.description ?? '';

const meta = { title: pageTitle, description: pageDescription };

const { icon, emoji } = parentPage ? getNavLabelParts(parentPage) : { icon: undefined, emoji: undefined };

const introParagraphs = category?.description
  ? [category.description]
  : parentPage
  ? getIntroParagraphs(parentPage)
  : [];

const backHref = parentPage ? `${parentHref.replace(/\/+$/, '')}/`.replace(/\/{2,}/g, '/') : undefined;
const backLabel = parentPage ? `← ${parentPage.title}` : undefined;
---
<Template.Base title={pageTitle} meta={meta}>
  {backHref && backLabel ? (
    <Template.HeaderActions slot="header__actions" href={backHref} label={backLabel} />
  ) : null}

  <section class="content-section content-section--head">
    <Template.Card class="card--plain card--center">
      <Fragment slot="head">
        <Template.TitleWithIcon
          class="card__title"
          title={pageTitle}
          icon={icon}
          emoji={emoji}
        />
      </Fragment>
      {introParagraphs.length > 0 ? (
        <Fragment slot="body">
          <div class="prose">
            {introParagraphs.map((paragraph) => (
              <p>{paragraph}</p>
            ))}
          </div>
        </Fragment>
      ) : null}
    </Template.Card>
  </section>

  {errorMessage ? (
    <section class="content-section">
      <Template.Card class=" card--center">
        <Fragment slot="body">
          <p>{errorMessage}</p>
        </Fragment>
      </Template.Card>
    </section>
  ) : hasEntries ? (
    <section class="content-section cols-3">
      {normalizedEntries.map((entry) => (
        <Template.TileView
          href={entry.href}
          title={entry.title}
          description={entry.description}
          dataSlug={entry.dataSlug}
          cover={entry.cover}
          date={entry.date}
          count={entry.count}
          countLabel={entry.countLabel}
        />
      ))}
    </section>
  ) : (
    <section class="content-section">
      <Template.Card class=" card--center">
        <Fragment slot="body">
          <p>No entries yet — check back soon!</p>
        </Fragment>
      </Template.Card>
    </section>
  )}
</Template.Base>
