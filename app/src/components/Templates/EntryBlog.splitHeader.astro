---
import { Template } from '@Frontend';
import ICONS from '@Assets/Icons.astro';
interface BlogChapterView {
  id: string;
  title: string;
  summary?: string;
}

interface BlogViewData {
  title: string;
  description?: string;
  introParagraphs: string[];
  cover: any; // ImageMetadata
  chapters?: BlogChapterView[];
  category?: string;
  date?: Date | string;
}

interface Props {
  blog: BlogViewData;
  BlogContent?: any;
}

const { blog, BlogContent } = Astro.props;

const blogChapters = blog.chapters ?? [];
const hasBlogChapters = blogChapters.length > 0;
const blogSummaryParagraphs = blog.introParagraphs ?? [];
const blogDescription = blog.description ?? '';
const hasBlogSummary = blogDescription.length > 0 || blogSummaryParagraphs.length > 0;
const formattedDate =
  blog.date instanceof Date
    ? new Intl.DateTimeFormat('de', { month: 'long', year: 'numeric' }).format(blog.date)
    : typeof blog.date === 'string' && blog.date.trim().length
    ? blog.date
    : undefined;
---
<style>
  .entry-header {
    display: grid;
    grid-template-columns: 55% auto;
    gap: var(--card-gap);
    align-items: center;
  }
  @media (max-width: 900px) {
    .entry-header {
      grid-template-columns: 1fr;
      place-items: center;  
    }
  }
  .entry-header__content {
    display: flex;
    flex-direction: column;
    gap: var(--flow-gap);
    align-items: center;
    padding: var(--card-padding);
  }

  .entry-header__eyebrow {
    font-size: var(--font-size-s);
    opacity: 0.7;
    line-height: var(--line-height-xxs);
    letter-spacing: var(--letter-spacing-xxl)
  }

  .entry-content {
    display: grid;
    grid-template-columns: 33% auto;
    gap: var(--card-gap);
    position: relative;
  }

  @media (max-width: 900px) {
    .entry-content {
      grid-template-rows: 1fr auto;
      grid-template-columns: 1fr;
    }
  }
/* Vertikaler Divider zwischen ToC und Inhalt */
.entry-content::before {
  content: "";
  position: absolute;
  inset-block: var(--card-padding); /* oben/unten bündig mit Card-Padding */
  inset-inline-start: calc(33% + (var(--card-gap) / 2));
  inline-size: 1px;
  background: linear-gradient(
    to bottom,
    transparent -5%,
    color-mix(in oklab, var(--color-accent-light--ghosty) 70%, transparent),
    transparent 105%
  );
  pointer-events: none;
}

@media (max-width: 900px) {
  .entry-content::before {
  display: none;
  }
}

.card--ghost {
  background-color: transparent;
}
.card__divider {display: none;}
.card--content {
  padding-block: 0; padding-inline-start: 0;
}
.card--chapter {padding-block: 0; padding-inline-end: 0;}
@media (max-width: 900px) {
  .card--content,
  .card--chapter {
    padding-inline: 0;
  }
  .card--content + .card__divider {  
    display: inline-block;
    height: 1px;
    margin-block: var(--card-gap);
    background: linear-gradient(
    to right,
    transparent -5%,
    color-mix(in oklab, var(--color-accent-light--ghosty) 70%, transparent),
    transparent 105%
  );}  
  .card--content :where(.card__list-summary)
  {
    display: none;
  }
}  
</style>

<section class="content-section content-section--head" id="article-top">
  <Template.Card class="card--center">
    <Fragment slot="body">
      <header class="entry-header">
        <div class="entry-header__content">
          {/* Eyebrow / Kategorie oben klein */}
          {blog.category ? (
            <p class="entry-header__eyebrow is-signature is-italic">
              {blog.category}
            </p>
          ) : null}

          <h1 class="card__title is-fancy">
            {blog.title}
          </h1>

          {blogDescription ? (
            <div class="prose">
              <p class="is-italic">{blogDescription}</p>
            </div>
          ) : null}

          {(formattedDate || blog.category || hasBlogChapters) && (
            <div class="card__badges controls controls--tight">
              {formattedDate ? (
                <span class="control control--badge">{formattedDate}</span>
              ) : null}

              {blog.category ? (
                <span class="control control--badge">*some tag*</span>
              ) : null}
              {hasBlogChapters ? (
                <span class="control control--badge">Chapters: {blogChapters.length}</span>
              ) : null}
            </div>
          )}
        </div>
        <div class="media-frame media-frame--banner">
          <img
            src={blog.cover.src}
            alt={blog.title}
            class="media-image media-image--cover media-image--top"
          />
        </div>        
      </header>
    </Fragment>
  </Template.Card>
</section>


<section class="content-section">
  {hasBlogChapters ? (
    <div class="card entry-content">

      <div class="card card--plain card--content">
        <div class="card__head">
          <h2 class="card__title">Table of Contents</h2>
        </div>

        <div class="card__body">
          <ol class="card__list">
            {blogChapters.map((chapter, index) => (
              <li class="card__list-item">
                <a class="card__list-link" href={`#${chapter.id}`} data-chapter={chapter.id}>
                  <strong class="card__list-index" aria-hidden="true">{String(index + 1).padStart(2, '0')}</strong>
                  <div class="card__list-chapter">
                    <strong class="card__list-title">{chapter.title}</strong>
                    {chapter.summary ? 
                      <span class="card__list-summary">{chapter.summary}</span> 
                    : null}
                  </div>
                </a>
              </li>
            ))}
          </ol>
        </div>
      </div>
      <span class="card__divider"></span>
      <div class="card card--plain card--chapter">
        <div class="card__head">
          <h1 class="card__title" data-chapter-title>
            {hasBlogChapters ? blogChapters[0].title : 'Chapter'}
          </h1>
        </div>

        <div class="card__body">
          <article class="prose prose--unlimited" id="blog-chapter-target">
            {BlogContent ? <BlogContent /> : <p>There is no article content to show just yet.</p>}
          </article>
        </div>

        {hasBlogChapters ? (
          <div class="card__foot">
            <nav class="controls controls--spread">
              <button
                class="control control--button control--circle"
                type="button"
                data-chapter-prev
              >
                <ICONS class="media-icon media-icon--small" kind="previous" />
              </button>

              <button
                class="control control--button control--circle"
                type="button"
                data-chapter-next
              >
                <ICONS class="media-icon media-icon--small" kind="next" />
              </button>
            </nav>
          </div>
        ) : null}
      </div>
    </div>
  ) : null}
</section>

{hasBlogChapters && blogChapters ? (
  <>
    {/* Daten-Container */}
    <div
      id="blog-chapters-data"
      data-chapters={JSON.stringify(blogChapters)}
      hidden
    ></div>

    {/* echtes Script */}

  </>
) : null}


 

<section class="content-section">{/* Platz für Related / Comments / whatever */}</section>

<script>
  import initBlogChapters from '@Scripts/initBlogChapters.js';
  import { runOnReady } from '@Scripts/utils/_runOnReady.js';

  runOnReady(() => {
    const cleanup = initBlogChapters();
    if (typeof cleanup === 'function') {
      window.addEventListener('astro:before-swap', cleanup, { once: true });
    }
  });
</script>

