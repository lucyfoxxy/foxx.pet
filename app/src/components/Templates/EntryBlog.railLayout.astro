---
import { Template } from '@Frontend';
import ICONS from '@Assets/Icons.astro';
interface BlogChapterView {
  id: string;
  title: string;
  summary?: string;
}

interface BlogViewData {
  title: string;
  description?: string;
  introParagraphs: string[];
  cover: any; // ImageMetadata
  chapters?: BlogChapterView[];
  category?: string;
  date?: Date | string;
}

interface Props {
  blog: BlogViewData;
  BlogContent?: any;
}

const { blog, BlogContent } = Astro.props;

const blogChapters = blog.chapters ?? [];
const hasBlogChapters = blogChapters.length > 0;
const blogSummaryParagraphs = blog.introParagraphs ?? [];
const blogDescription = blog.description ?? '';
const hasBlogSummary = blogDescription.length > 0 || blogSummaryParagraphs.length > 0;
const formattedDate =
  blog.date instanceof Date
    ? new Intl.DateTimeFormat('en', { month: 'short', year: 'numeric' }).format(blog.date)
    : typeof blog.date === 'string' && blog.date.trim().length
    ? blog.date
    : undefined;
---

<section class="content-section content-section--head" id="article-top">
  <Template.Card class="card--center card--flush" footOverlayClass="card__overlay--plain">

    <Fragment slot="headOverlay">
      <span class="card__overlay-item"><h2 class="is-fancy">{blog.title}</h2></span>

      {blogDescription ? <span class="card__overlay-item"><p>{blogDescription}</p></span> : null}

    </Fragment>
    <Fragment slot="footOverlay">
                            {(formattedDate || blog.category || blog) && (
          <div class="card__overlay-item card__badges controls controls--end">
            
            <span class="control control--badge">
              {formattedDate ? formattedDate : '1900-01-01'}
            </span>

            <span class="control control--badge">
              {blog.category ? blog.category : 'category'}
            </span>               
          </div>)} 

    </Fragment>
    <Fragment slot="body">
      <div class="media-frame">
        <img
          src={blog.cover.src}
          alt={blog.title}
          class="media-image media-image--top media-image--cover"
        />
      </div>
    </Fragment>
  </Template.Card>
</section>

<section class="content-section content-section--rail">
  {hasBlogChapters ? (
    <Template.Card class="card--stretch card--rail">
      <Fragment slot="body">
        <div class="entry-rail">
          {/* ------- TOC / RAIL ------- */}
          <aside class="entry-rail__toc" aria-label="Chapters">
            <header class="entry-rail__toc-header">
              <h2 class="card__title entry-rail__toc-title">Table of Contents</h2>

              <div class="card__badges controls controls--tight">
                <span class="control control--badge">
                  {blogChapters.length} chapters
                </span>
              </div>
            </header>

            <ol class="entry-rail__toc-list">
              {blogChapters.map((chapter, index) => (
                <li>
                  <a
                    href={`#${chapter.id}`}
                    data-chapter={chapter.id}
                    class="entry-rail__toc-link control control--plain"
                  >
                    <span
                      class="entry-rail__toc-index"
                      aria-hidden="true"
                    >
                      {String(index + 1).padStart(2, '0')}
                    </span>

                    <span class="entry-rail__toc-text">
                      <strong>{chapter.title}</strong>
                      {chapter.summary ? <span>{chapter.summary}</span> : null}
                    </span>
                  </a>
                </li>
              ))}
            </ol>
          </aside>

          {/* ------- CONTENT ------- */}
          <div class="entry-rail__content">
            <header class="entry-rail__content-header">
              {/* Meta-Badges (Date + Category) – nutzt dein vorhandenes formattedDate / blog.category */}
              <div class="controls controls--tight entry-rail__meta">
                {formattedDate ? (
                  <span class="control control--badge">
                    {formattedDate}
                  </span>
                ) : null}

                {blog.category ? (
                  <span class="control control--badge">
                    {blog.category}
                  </span>
                ) : null}
              </div>

              <h2 class="card__title" data-chapter-title>
                {hasBlogChapters ? blogChapters[0].title : 'Chapter'}
              </h2>
            </header>

            <article
              class="prose entry-rail__article"
              id="blog-chapter-target"
            >
              {BlogContent ? (
                <BlogContent />
              ) : (
                <p>There is no article content to show just yet.</p>
              )}
            </article>

            {hasBlogChapters ? (
              <footer class="entry-rail__footer">
                <nav
                  class="controls controls--spread entry-rail__pager"
                  aria-label="Browse chapters"
                >
                  <button
                    class="control control--button control--circle"
                    type="button"
                    data-chapter-prev
                  >
                    <ICONS
                      class="media-icon media-icon--small"
                      kind="previous"
                    />
                  </button>

                  <button
                    class="control control--button control--circle"
                    type="button"
                    data-chapter-next
                  >
                    <ICONS
                      class="media-icon media-icon--small"
                      kind="next"
                    />
                  </button>
                </nav>
              </footer>
            ) : null}
          </div>
        </div>
      </Fragment>
    </Template.Card>
  ) : (
    /* Fallback: kein Kapitel-Setup -> einfach Content */
    <Template.Card>
      <Fragment slot="body">
        <article class="prose">
          {BlogContent ? (
            <BlogContent />
          ) : (
            <p>There is no article content to show just yet.</p>
          )}
        </article>
      </Fragment>
    </Template.Card>
  )}
</section>


{hasBlogChapters && blogChapters ? (
  <>
    {/* Daten-Container */}
    <div
      id="blog-chapters-data"
      data-chapters={JSON.stringify(blogChapters)}
      hidden
    ></div>

    {/* echtes Script */}

  </>
) : null}


 

<section class="content-section">{/* Platz für Related / Comments / whatever */}</section>
<style>
  .content-section--rail .card--rail {
    /* optional etwas mehr Luft im Rail-Layout */
    padding-block: var(--card-padding);
  }

  .entry-rail {
    display: grid;
    grid-template-columns: minmax(0, 0.85fr) minmax(0, 1.9fr);
    gap: var(--flow-gap);
    align-items: flex-start;
  }

  /* TOC / Rail */
  .entry-rail__toc {
    position: sticky;
    top: var(--panel-padding);
    align-self: flex-start;
    display: grid;
    gap: calc(var(--flow-gap) * 0.75);
  }

  .entry-rail__toc-title {
    margin-block-end: 0;
  }

  .entry-rail__toc-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: calc(var(--flow-gap) * 0.5);
  }

  .entry-rail__toc-link {
    inline-size: 100%;
    justify-content: flex-start;
  }

  .entry-rail__toc-link[data-active="true"] {
    font-weight: 600;
  }

  .entry-rail__toc-index {
    font-variant-numeric: tabular-nums;
    opacity: 0.7;
    min-inline-size: 2.3ch;
  }

  .entry-rail__toc-text {
    display: inline-flex;
    flex-direction: column;
    gap: 0.15em;
  }

  .entry-rail__toc-text > span {
    font-size: var(--font-size-s);
    opacity: 0.8;
  }

  /* Content */
  .entry-rail__content {
    display: grid;
    gap: var(--flow-gap);
  }

  .entry-rail__content-header {
    display: grid;
    gap: calc(var(--flow-gap) * 0.5);
  }

  .entry-rail__meta {
    justify-content: flex-start;
    flex-wrap: wrap;
  }

  .entry-rail__article {
    scroll-margin-top: var(--flow-gap);
  }

  .entry-rail__footer {
    margin-block-start: calc(var(--flow-gap) * 0.5);
  }

  /* Prev/Next: gleiche Position, ausgeblendet wenn disabled */
  .entry-rail__pager .control.is-disabled,
  .entry-rail__pager .control[disabled] {
    opacity: 0;
    pointer-events: none;
  }

  /* Dein bestehender Hack, damit die h2 im Content + hidden Blöcke nicht doppelt erscheinen */
  .prose#blog-chapter-target > :is(*[hidden], h2) {
    display: none;
  }

  /* Responsive: Rail wird untereinander gestapelt */
  @media (max-width: 900px) {
    .entry-rail {
      grid-template-columns: minmax(0, 1fr);
      gap: calc(var(--flow-gap) * 1.25);
    }

    .entry-rail__toc {
      position: static;
      order: -1;
    }
  }
</style>

<script>
  import initBlogChapters from '@Scripts/initBlogChapters.js';
  import { runOnReady } from '@Scripts/utils/_runOnReady.js';

  runOnReady(() => {
    const cleanup = initBlogChapters();
    if (typeof cleanup === 'function') {
      window.addEventListener('astro:before-swap', cleanup, { once: true });
    }
  });
</script>

