---
import { Template } from '@Frontend';
import ICONS from '@Assets/Icons.astro';
interface BlogChapterView {
  id: string;
  title: string;
  summary?: string;
}

interface BlogViewData {
  title: string;
  description?: string;
  introParagraphs: string[];
  cover: any; // ImageMetadata
  chapters?: BlogChapterView[];
}

interface Props {
  blog: BlogViewData;
  BlogContent?: any;
}

const { blog, BlogContent } = Astro.props;

const blogChapters = blog.chapters ?? [];
const hasBlogChapters = blogChapters.length > 0;
const blogSummaryParagraphs = blog.introParagraphs ?? [];
const blogDescription = blog.description ?? '';
const hasBlogSummary = blogDescription.length > 0 || blogSummaryParagraphs.length > 0;

---

<section class="content-section content-section--head" id="article-top">
  <Template.Card class="card--center" headClass="card__head--column">
    <Fragment slot="head">
      <h1>{blog.title}</h1>
      {blogDescription ? <span class="card__overlay-item"><p>{blogDescription}</p></span> : null}
    </Fragment>

    <Fragment slot="body">
      <div class="media-frame">
        <img
          src={blog.cover.src}
          alt={blog.title}
          class="media-image media-image--top media-image--cover"
        />
      </div>
    </Fragment>
  </Template.Card>
</section>

<section class="content-section content-section--masonry">
  {hasBlogChapters ? (
    <Template.Card class="">
      <Fragment slot="head">
        <h2 class="card__title">Table of Contents</h2>
        <div class="card__badges controls controls--tight">
          <span class="control control--badge">{blogChapters.length} total</span>
        </div>
      </Fragment>
      <Fragment slot="body">
        <ol>
          {blogChapters.map((chapter, index) => (
            <li>
              <a
                href={`#${chapter.id}`}
                data-chapter={chapter.id}
              >
                <span aria-hidden="true">{String(index + 1).padStart(2, '0')}</span>
                <div>
                  <strong>{chapter.title}</strong>
                  {chapter.summary ? <span>{chapter.summary}</span> : null}
                </div>
              </a>
            </li>
          ))}
        </ol>

      </Fragment>
    </Template.Card>
  ) : null}



  {hasBlogChapters ? (
    <Template.Card headClass={hasBlogChapters ? '' : undefined}>
      <Fragment slot="head">
        <h2 class="card__title" data-chapter-title>
          {hasBlogChapters ? blogChapters[0].title : 'Chapter'}
        </h2>
      </Fragment>

      <Fragment slot="body">
        <article class="prose" id="blog-chapter-target">
          {BlogContent ? <BlogContent /> : <p>There is no article content to show just yet.</p>}
        </article>
      </Fragment>

      {hasBlogChapters ? (
        <Fragment slot="foot">
          <nav class="controls controls--spread">
            <button
              class="control control--button control--circle"
              type="button"
              data-chapter-prev
            >
              <ICONS kind="previous" />
            </button>

            <button
              class="control control--button control--circle"
              type="button"
              data-chapter-next
            >
              <ICONS kind="next" />
            </button>
          </nav>
        </Fragment>
      ) : null}
    </Template.Card>
) : null}
  </section>

{hasBlogChapters && blogChapters ? (
  <>
    {/* Daten-Container */}
    <div
      id="blog-chapters-data"
      data-chapters={JSON.stringify(blogChapters)}
      hidden
    ></div>

    {/* echtes Script */}

  </>
) : null}


 

<section class="content-section">{/* Platz f√ºr Related / Comments / whatever */}</section>
<script>
  (function () {
    if (window.__blogChaptersBootInstalled) return;
    window.__blogChaptersBootInstalled = true;

    function bootBlogChapters() {
      // alte Listener von der vorherigen Seite entfernen
      if (window.__blogChaptersCleanup) {
        window.__blogChaptersCleanup();
        window.__blogChaptersCleanup = null;
      }

      var dataEl = document.getElementById('blog-chapters-data');
      if (!dataEl) return; // keine Blogseite

      var raw = dataEl.dataset.chapters;
      if (!raw) return;

      var chapters;
      try {
        chapters = JSON.parse(raw);
      } catch (err) {
        console.warn('Blog chapters JSON invalid:', err, raw);
        return;
      }

      if (!Array.isArray(chapters) || !chapters.length) return;

      if (typeof window.initBlogChapters === 'function') {
        window.initBlogChapters({
          chapters: chapters,
          targetSelector: '#blog-chapter-target',
          titleSelector: '[data-chapter-title]',
          prevSelector: '[data-chapter-prev]',
          nextSelector: '[data-chapter-next]',
        });
      }
    }

    // erstes Laden der Seite
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bootBlogChapters, {
        once: true,
      });
    } else {
      bootBlogChapters();
    }

    // JEDER Astro-Seitenwechsel
    document.addEventListener('astro:page-load', function () {
      bootBlogChapters();
    });
  })();
</script>
