---
import { View } from '@Frontend';
import { getPageContent } from '@Content/siteContent';
import { getEntriesBySectionAndCategory, isAlbumEntry } from '@utils/getEntries';

export const prerender = true;

type StaticProps = {
  albumSlug?: string;
  backToParentCategory?: boolean;
};

export async function getStaticPaths() {
  const page = await getPageContent('frames');
  const categories = page.categories ?? [];

  const paths = await Promise.all(
    categories.map(async (category) => {
      const slug = category.slug?.trim();
      if (!slug) return undefined;

      const entries = await getEntriesBySectionAndCategory('frames', slug);
      const albumEntries = entries.filter(isAlbumEntry);
      const onlyAlbum = albumEntries.length === 1 ? albumEntries[0] : undefined;

      const props: StaticProps = onlyAlbum
        ? { albumSlug: onlyAlbum.data.slug, backToParentCategory: true }
        : {};

      return {
        params: { slug },
        props,
      };
    }),
  );

  return paths.filter((value): value is { params: { slug: string }; props: StaticProps } => Boolean(value));
}

const { slug } = Astro.params;

if (!slug) {
  throw new Error('Missing frames category slug');
}

const { albumSlug, backToParentCategory = false } = Astro.props as StaticProps;
---
{albumSlug ? (
  <View.Entry section="frames" slug={albumSlug} backToParentCategory={backToParentCategory} />
) : (
  <View.Category section="frames" slug={slug} />
)}
