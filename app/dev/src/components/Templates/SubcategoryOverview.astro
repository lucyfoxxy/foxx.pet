---
import BaseTemplate from '@Templates/BaseTemplate.astro';
import Card from '@Templates/Card.astro';
import TitleWithIcon from '@Templates/partials/TitleWithIcon.astro';
import { Picture } from 'astro:assets';
import { COVERS } from '@Assets/covers';
import {
  findCategory,
  getIntroParagraphs,
  getNavLabelParts,
  getPageContent,
} from '@Content/siteContent';
import { getCollection } from 'astro:content';

interface Props {
  slug: string;
}

const { slug } = Astro.props as Props;
const pathSegments = Astro.url.pathname.replace(/\/+$/, '').split('/').filter(Boolean);
const areaSegment = pathSegments[0];
const parentSlug = pathSegments[1];

if (!areaSegment || !parentSlug) {
  throw new Error('Unable to resolve subcategory context from the current URL.');
}

const area = areaSegment === 'album' ? 'album' : areaSegment === 'blog' ? 'blog' : null;

if (!area) {
  throw new Error(`Unsupported content area "${areaSegment}" for subcategory overview.`);
}

const parentPage = await getPageContent(parentSlug);
const subCategory = findCategory(parentPage, slug);

if (!subCategory) {
  throw new Error(`Unknown subcategory "${slug}" for page "${parentSlug}".`);
}

const { icon, emoji } = getNavLabelParts(parentPage);
const introParagraphs = subCategory.description
  ? [subCategory.description]
  : getIntroParagraphs(parentPage);

const backHref = `${parentPage.href.replace(/\/+$/, '')}/`;
const backLabel = `← ${parentPage.title}`;

const placeholderCover = COVERS.placeholder;

type AlbumEntry = {
  slug: string;
  title: string;
  description: string;
  count?: number;
  formattedStartDate?: string;
  coverUrl?: string;
};

type ArticleEntry = {
  slug: string;
  title: string;
  description: string;
  publishDate?: Date;
  cover: typeof placeholderCover;
};

const albumEntries = area === 'album'
  ? (await getCollection('album', ({ data }) => (data.category?.slug ?? '') === slug)).map(({ data }, index) => {
      const title = data.title ?? data.albumName ?? data.slug;
      const description = data.description ?? data.albumName ?? '';
      const startDateValue = data.startDate ? Date.parse(data.startDate) : Number.NaN;
      const hasStartDate = Number.isFinite(startDateValue);
      const formattedStartDate = hasStartDate
        ? new Intl.DateTimeFormat('en', { month: 'short', year: 'numeric' }).format(new Date(startDateValue))
        : undefined;
      const shareKey = data.shareKey ?? undefined;
      const albumThumbnailAssetId = data.albumThumbnailAssetId ?? undefined;
      const coverUrl =
        data.coverUrl ??
        (shareKey && albumThumbnailAssetId
          ? `https://img.foxx.pet/api/assets/${albumThumbnailAssetId}/thumbnail?key=${shareKey}`
          : undefined);

      return {
        slug: data.slug,
        title,
        description,
        count: data.count,
        formattedStartDate,
        coverUrl,
        _sort: hasStartDate ? startDateValue : undefined,
        _index: index,
      };
    })
      .sort((a, b) => {
        const aHas = typeof a._sort === 'number';
        const bHas = typeof b._sort === 'number';
        if (aHas && bHas) {
          return (b._sort as number) - (a._sort as number);
        }
        if (aHas) return -1;
        if (bHas) return 1;
        return a._index - b._index;
      })
      .map(({ _sort, _index, ...entry }) => entry)
  : [];

const articleEntries = area === 'blog'
  ? (await getCollection('blog', ({ data }) => data.primaryCategory === slug))
      .map((entry) => ({
        slug: entry.slug,
        title: entry.data.title,
        description: entry.data.description ?? '',
        publishDate: entry.data.publishDate,
        cover: COVERS[entry.slug] ?? placeholderCover,
      }))
      .sort((a, b) => b.publishDate.getTime() - a.publishDate.getTime())
  : [];

const hasEntries = area === 'album' ? albumEntries.length > 0 : articleEntries.length > 0;

const meta = {
  title: subCategory.title,
  description: subCategory.description ?? parentPage.description ?? '',
};
---
<BaseTemplate title={subCategory.title} meta={meta}>
  <Fragment slot="header__actions">
    <a class="button button--small button--dark" href={backHref}>{backLabel}</a>
  </Fragment>

  <section class="content-section">
    <Card class="card--plain is-centered">
      <Fragment slot="head">
        <TitleWithIcon class="card__title" title={subCategory.title} icon={icon} emoji={emoji} />
      </Fragment>
      {introParagraphs.length > 0 && (
        <Fragment slot="body">
          <div class="prose">
            {introParagraphs.map((paragraph) => (
              <p>{paragraph}</p>
            ))}
          </div>
        </Fragment>
      )}
    </Card>
  </section>

  {hasEntries ? (
    <section class="content-section cols-3">
      {area === 'album'
        ? albumEntries.map(({ slug: albumSlug, title, description, count, formattedStartDate, coverUrl }) => {
            const itemHref = `/${areaSegment}/${parentSlug}/${slug}/${albumSlug}/`;
            const badgeLabel =
              typeof count === 'number' ? (count > 0 ? `${count} photos` : 'No photos yet') : undefined;

            return (
              <a href={itemHref} aria-label={`Open ${title}`}>
                <Card class="card--light is-centered is-animated" headClass="card__head--column">
                  <Fragment slot="head">
                    <h3 class="card__title">{title}</h3>
                    {(formattedStartDate || badgeLabel) && (
                      <div class="card__badges controls controls--tight">
                        {formattedStartDate ? <span class="badge badge--dark">{formattedStartDate}</span> : null}
                        {badgeLabel ? <span class="badge badge--dark">{badgeLabel}</span> : null}
                      </div>
                    )}
                  </Fragment>
                  <Fragment slot="body">
                    <div class="media-frame" data-slug={albumSlug}>
                      {coverUrl ? (
                        <img class="media-image" src={coverUrl} alt="" loading="lazy" decoding="async" />
                      ) : (
                        <div class="media-image placeholder" aria-hidden="true"></div>
                      )}
                    </div>
                    {description ? <p>{description}</p> : null}
                  </Fragment>
                </Card>
              </a>
            );
          })
        : articleEntries.map(({ slug: articleSlug, title, description, publishDate, cover }) => {
            const itemHref = `/${areaSegment}/${parentSlug}/${articleSlug}/`;
            const formattedDate = publishDate
              ? new Intl.DateTimeFormat('en', { dateStyle: 'medium' }).format(publishDate)
              : undefined;

            return (
              <a href={itemHref} aria-label={`Read ${title}`}>
                <Card class="card--light is-animated" headClass="card__head--column">
                  <Fragment slot="head">
                    <h3 class="card__title">{title}</h3>
                    {formattedDate ? (
                      <div class="card__badges controls controls--tight">
                        <span class="badge badge--dark">{formattedDate}</span>
                      </div>
                    ) : null}
                  </Fragment>
                  <Fragment slot="body">
                    <div class="media-frame" data-slug={articleSlug}>
                      <Picture
                        src={cover}
                        formats={['avif', 'webp']}
                        alt=""
                        class="media-image"
                        loading="lazy"
                        decoding="async"
                      />
                    </div>
                    {description ? <p>{description}</p> : null}
                  </Fragment>
                </Card>
              </a>
            );
          })}
    </section>
  ) : (
    <section class="content-section">
      <Card class="card--ghost is-centered">
        <Fragment slot="body">
          <p>No entries yet — check back soon!</p>
        </Fragment>
      </Card>
    </section>
  )}
</BaseTemplate>
