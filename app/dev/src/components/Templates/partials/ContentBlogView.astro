---
import Card from '@Templates/Card.astro';
import { Picture } from 'astro:assets';

interface BlogChapterView {
  id: string;
  title: string;
  summary?: string;
}

interface BlogViewData {
  title: string;
  description?: string;
  introParagraphs: string[];
  cover: any; // ImageMetadata
  chapters?: BlogChapterView[];
}

interface Props {
  blog: BlogViewData;
  BlogContent?: any;
}

const { blog, BlogContent } = Astro.props;

const blogChapters = blog.chapters ?? [];
const hasBlogChapters = blogChapters.length > 0;
const blogSummaryParagraphs = blog.introParagraphs ?? [];
const blogDescription = blog.description ?? '';
const hasBlogSummary = blogDescription.length > 0 || blogSummaryParagraphs.length > 0;
const firstChapter = hasBlogChapters ? blogChapters[0] : undefined;
const lastChapter = hasBlogChapters ? blogChapters[blogChapters.length - 1] : undefined;
---

<section class="content-section" id="article-top">
  <Card class="card--ghost card--flush" headClass="card__head--column">
    <Fragment slot="head">
      <div class="card__hero-banner">
        <Picture
          src={blog.cover}
          formats={['avif', 'webp']}
          alt={blog.title}
          class="media-image media-image--hero"
        />
        <div class="card__overlay card__overlay--title card__overlay--column card__overlay--bottom">
          <h1 class="card__title">{blog.title}</h1>
          {blogDescription ? <p>{blogDescription}</p> : null}
        </div>
      </div>
    </Fragment>
  </Card>
</section>

{hasBlogChapters || hasBlogSummary ? (
  <section class:list={['content-section', hasBlogChapters && hasBlogSummary ? 'cols-2' : undefined]}>
    {hasBlogChapters ? (
      <Card class="card--ghost">
        <Fragment slot="head">
          <h2 class="card__title">Table of Contents</h2>
          <div class="card__badges controls controls--tight">
            <span class="badge badge--dark">{blogChapters.length} total</span>
          </div>
        </Fragment>
        <Fragment slot="body">
          <ol>
            {blogChapters.map((chapter, index) => (
              <li>
                <a
                  href={`#${chapter.id}`}
                  data-chapter={chapter.id}
                >
                  <span aria-hidden="true">{String(index + 1).padStart(2, '0')}</span>
                  <div>
                    <strong>{chapter.title}</strong>
                    {chapter.summary ? <span>{chapter.summary}</span> : null}
                  </div>
                </a>
              </li>
            ))}
          </ol>

        </Fragment>
      </Card>
    ) : null}

    <Card headClass={hasBlogChapters ? '' : undefined}>
      {hasBlogChapters ? (
        <Fragment slot="head">
    <h2 class="card__title" data-chapter-title>
      {hasBlogChapters ? blogChapters[0].title : 'Chapter'}
    </h2>
        </Fragment>
      ) : null}

      <Fragment slot="body">
        <article class="prose" id="blog-chapter-target">
          {BlogContent ? <BlogContent /> : <p>There is no article content to show just yet.</p>}
        </article>
      </Fragment>

      {hasBlogChapters ? (
        <Fragment slot="foot">
          <nav class="controls controls--spread">
            <button
              class="button button--small button--dark button--round"
              type="button"
              data-chapter-prev
            >
              ← Prev
            </button>

            <button
              class="button button--small button--dark button--round"
              type="button"
              data-chapter-next
            >
              Next →
            </button>
          </nav>
        </Fragment>
      ) : null}
    </Card>

  </section>
) : null}
{hasBlogChapters && blogChapters ? (
  <>
    {/* Daten-Container */}
    <div
      id="blog-chapters-data"
      data-chapters={JSON.stringify(blogChapters)}
      hidden
    ></div>

    {/* echtes Script */}
    <script>
      import initBlogChapters from '@Scripts/initBlogChapters.js';
      import { runOnReady } from '@Scripts/utils/_runOnReady.js';

      runOnReady(() => {
        const dataEl = document.getElementById('blog-chapters-data');
        if (!dataEl) return;

        const raw = dataEl.dataset.chapters || '[]';
        let chapters = [];
        try {
          chapters = JSON.parse(raw);
        } catch (err) {
          console.warn('Blog chapters JSON broken:', err, raw);
          return;
        }

        initBlogChapters({
          chapters,
          targetSelector: '#blog-chapter-target',
          titleSelector: '[data-chapter-title]',
          prevSelector: '[data-chapter-prev]',
          nextSelector: '[data-chapter-next]',
        });
      });
    </script>
  </>
) : null}


 

<section class="content-section">{/* Platz für Related / Comments / whatever */}</section>
