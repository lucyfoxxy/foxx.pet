---
import '@Styles/tokens.css';
import '@Styles/bg.css'
import '@Styles/base.css';
import '@Styles/typography.css';
import '@Styles/site.css';
import '@Styles/content.css';
import '@Styles/ui.css';
import '@Styles/media.css';
import '@Styles/table.css';

import { ASSETS } from '@Assets/ui';
import { getNavigationLinks, getPageContent } from '@Content/siteContent';
import Head from '@Layout/Head.astro';
import SiteHeader from '@Layout/SiteHeader.astro';
import SiteFooter from '@Layout/SiteFooter.astro';
import Helpers from '@Layout/Helpers.astro';

// ---------------------------------------------------------------------------
// Types & helpers
// ---------------------------------------------------------------------------
type NavLink = Awaited<ReturnType<typeof getNavigationLinks>>[number];

type Breadcrumb = {
  label: string;
  href: string;
  isCurrent: boolean;
};

type LayoutMeta = {
  title: string;
  description: string;
  url: string;
};

type LayoutProps = {
  title?: string;
  meta?: Partial<LayoutMeta>;
};

const normalizePath = (path: string) => {
  if (!path || path === '/') return '/';
  return path.replace(/\/+$/, '') || '/';
};

const toTitleCase = (value: string) =>
  value
    .split(/[-_]/g)
    .filter(Boolean)
    .map((segment) => segment.charAt(0).toUpperCase() + segment.slice(1))
    .join(' ');

const buildBreadcrumbs = ({
  currentPath,
  navLinks,
  pageTitle,
}: {
  currentPath: string;
  navLinks: NavLink[];
  pageTitle: string;
}): Breadcrumb[] => {
  const normalizedCurrentPath = normalizePath(currentPath);
  const navLabelByPath = new Map(navLinks.map((link) => [normalizePath(link.href), link.label]));
  const segments = normalizedCurrentPath === '/' ? [] : normalizedCurrentPath.slice(1).split('/');
  const collectedSegments: string[] = [];
  const homeLink = navLinks.find((link) => normalizePath(link.href) === '/');
  const homeLabel = homeLink ? homeLink.label : 'â†© Home';

  const crumbs: Breadcrumb[] = [
    {
      label: homeLabel,
      href: '/',
      isCurrent: segments.length === 0,
    },
  ];

  segments.forEach((segment, index) => {
    collectedSegments.push(segment);
    const href = normalizePath(`/${collectedSegments.join('/')}`);
    const isLast = index === segments.length - 1;
    let label = navLabelByPath.get(href) ?? toTitleCase(segment);
    if (isLast && pageTitle?.trim().length) {
      label = pageTitle.trim();
    }
    crumbs.push({
      label,
      href,
      isCurrent: isLast,
    });
  });

  return crumbs;
};

// ---------------------------------------------------------------------------
// Metadata setup
// ---------------------------------------------------------------------------
const homePage = await getPageContent('home');
const defaultMeta: LayoutMeta = {
  title: homePage.title,
  description: homePage.description,
  url: 'https://foxx.pet',
};

const props = (Astro.props ?? {}) as LayoutProps;
const meta: LayoutMeta = {
  ...defaultMeta,
  ...(props.meta ?? {}),
  title: props.title?.trim() || props.meta?.title?.trim() || defaultMeta.title,
};

const { title, description, url } = meta;

// ---------------------------------------------------------------------------
// Navigation & breadcrumbs
// ---------------------------------------------------------------------------
const rawNavLinks = await getNavigationLinks();
const currentPath = normalizePath(Astro.url.pathname);
const isLinkActive = (href: string) => {
  const target = normalizePath(href);
  if (target === '/') return currentPath === '/';
  return currentPath === target || currentPath.startsWith(`${target}/`);
};
const navLinks = rawNavLinks.map((link) => ({
  ...link,
  isActive: isLinkActive(link.href),
}));
const breadcrumbs = buildBreadcrumbs({
  currentPath: Astro.url.pathname,
  navLinks,
  pageTitle: title,
});
---
<html lang="en">
  <Head title={title} description={description} url={url} />
  <body style={`
                --bg-image: url(${ASSETS.bg.src});
                --bg-image--mobile: url(${ASSETS.container_bg.src});
                --bg--nebula: url(${ASSETS.bg__nebula.src});
                --bg--stars: url(${ASSETS.bg__stars.src});
                --bg--twinkle: url(${ASSETS.bg__twinkle.src});
              `}>

       
    <div class="container">
      <div class="panel-shell">
        <SiteHeader meta={meta} navLinks={navLinks} breadcrumbs={breadcrumbs}>
          {Astro.slots.has('header__actions') ? (
            <slot name="header__actions" slot="actions" />
          ) : null}
        </SiteHeader>
        <main class="panel">
          <slot />
        </main>
        <SiteFooter />
      </div>
    </div>
    <Helpers />
  </body>
</html>

