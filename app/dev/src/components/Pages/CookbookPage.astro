---
import { getCollection, type CollectionEntry } from 'astro:content';
import { getPageContent } from '@Content/siteContent';
import Card from '@Layout/Card.astro';

type RecipeEntry = CollectionEntry<'recipes'>;

const content = await getPageContent('cookbook');
const introParagraphs = content.introParagraphs ?? (content.description ? [content.description] : []);
const overview = content.overview ?? {};
const recipes = (await getCollection('recipes')).sort(
  (a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime(),
);

const categoryFacets = Array.from(
  new Set(recipes.flatMap((recipe) => recipe.data.categories ?? [])),
).sort((a, b) => a.localeCompare(b));

const tagFacets = Array.from(new Set(recipes.flatMap((recipe) => recipe.data.tags ?? []))).sort((a, b) =>
  a.localeCompare(b),
);

const formatDate = (date: Date) => new Intl.DateTimeFormat('en', { dateStyle: 'medium' }).format(date);
const hasRecipes = recipes.length > 0;
---

  <section class="content-section">
    <Card class="card--plain is-centered">
      <Fragment slot="head">
        <h1 class="card__title">{content.title}</h1>
      </Fragment>

      <Fragment slot="body">
        <div class="prose">
          {introParagraphs.map((paragraph) => (
            <p>{paragraph}</p>
          ))}
        </div>
      </Fragment>
    </Card>
  </section>

  {hasRecipes ? (
    <>
      <section class="content-section">
        <Card aria-labelledby="cookbook-facets" headClass="card__head--column">
          <Fragment slot="head">
            <h2 class="card__title" id="cookbook-facets">Plan your feast</h2>
          </Fragment>
          <Fragment slot="body">
            <p>
              Categories and tags make it simple to build seasonal menus or filter by dietary needs. Hook them into client-side
              state or query parameters for an experience similar to the gallery overview.
            </p>

            <div class="prose">
              {categoryFacets.length > 0 && (
                <p>
                  <strong>Categories:</strong>
                  {' '}
                  {categoryFacets.join(', ')}
                </p>
              )}
              {tagFacets.length > 0 && (
                <p>
                  <strong>Tags:</strong>
                  {' '}
                  {tagFacets.join(', ')}
                </p>
              )}
              {categoryFacets.length === 0 && tagFacets.length === 0 && (
                <p>
                  Start tagging recipes with flavour profiles, seasons, or difficulty to unlock richer filtering.
                </p>
              )}
            </div>
          </Fragment>
        </Card>
      </section>

      <section class="content-section cols-2">
        {recipes.map((recipe: RecipeEntry) => {
          const categories = recipe.data.categories ?? [];
          const tags = recipe.data.tags ?? [];
          const hasBadges = categories.length > 0 || tags.length > 0;
          return (
            <Card as="article" headClass="card__head--column">
              <Fragment slot="head">
                <h2 class="card__title">
                  <a href={`/cookbook/${recipe.slug}/`}>{recipe.data.title}</a>
                </h2>
                {hasBadges && (
                  <div class="card__badges controls controls--tight">
                    {categories.map((category) => (
                      <span class="badge badge--dark">{category}</span>
                    ))}
                    {tags.map((tag) => (
                      <span class="badge">{tag}</span>
                    ))}
                  </div>
                )}
              </Fragment>
              <Fragment slot="body">
                <p>
                  <strong>Published:</strong> {formatDate(recipe.data.publishDate)}
                </p>
                <div class="prose">
                  {recipe.data.description && <p>{recipe.data.description}</p>}
                  <ul>
                    {recipe.data.prepTime && (
                      <li>
                        <strong>Prep:</strong> {recipe.data.prepTime}
                      </li>
                    )}
                    {recipe.data.cookTime && (
                      <li>
                        <strong>Cook:</strong> {recipe.data.cookTime}
                      </li>
                    )}
                    {recipe.data.servings && (
                      <li>
                        <strong>Serves:</strong> {recipe.data.servings}
                      </li>
                    )}
                  </ul>
                </div>
              </Fragment>
              <Fragment slot="foot">
                <div class="controls controls--start">
                  <a class="button button--ghost" href={`/cookbook/${recipe.slug}/`}>
                    Open recipe â†’
                  </a>
                </div>
              </Fragment>
            </Card>
          );
        })}
      </section>
    </>
  ) : (
    <section class="content-section">
      <Card class="card--plain is-centered">
        <Fragment slot="head">
          <h2 class="card__title">{overview.emptyState ?? 'Cakes are still baking...'}</h2>
        </Fragment>

        <Fragment slot="body">
          <div class="prose">
            <p>{overview.cta ?? 'Add markdown recipes to populate this overview automatically.'}</p>
          </div>
        </Fragment>
      </Card>
    </section>
  )}
