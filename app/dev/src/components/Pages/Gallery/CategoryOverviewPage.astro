---
interface AlbumEntry {
  slug: string;
  title: string;
  description?: string;
  href?: string;
  count?: number;
  startDate?: string;
  shareKey?: string;
  albumThumbnailAssetId?: string;
  coverUrl?: string;
}

interface CategoryInfo {
  slug: string;
  title: string;
  description?: string;
}

import Card from '@UI/Card.astro';

const { category, albums } = Astro.props as {
  category: CategoryInfo;
  albums: AlbumEntry[];
};

const dateFormatter = new Intl.DateTimeFormat('en', { month: 'short', year: 'numeric' });

const normalizedAlbums = albums.map((album) => {
  const trimmedTitle = album.title.trim();
  const parsedStartDate = album.startDate ? Date.parse(album.startDate) : Number.NaN;
  const hasValidStartDate = Number.isFinite(parsedStartDate);
  const formattedStartDate = hasValidStartDate
    ? dateFormatter.format(new Date(parsedStartDate))
    : undefined;

  const coverUrl =
    album.coverUrl ??
    (album.shareKey && album.albumThumbnailAssetId
      ? `https://img.foxx.pet/api/assets/${album.albumThumbnailAssetId}/thumbnail?key=${album.shareKey}`
      : undefined);

  return {
    ...album,
    title: trimmedTitle,
    formattedStartDate,
    coverUrl,
  };
});
---

  <section class="content-section">
    <Card class="card--plain is-centered">
      <Fragment slot="head">
        <h1 class="card__title">{category.title}</h1>
      </Fragment>
      {category.description ? (
        <Fragment slot="body">
          <p>{category.description}</p>
        </Fragment>
      ) : null}
    </Card>
  </section>

  <section class="content-section cols-3">
    
      {normalizedAlbums.map(({
        slug,
        title,
        description,
        href,
        count,
        formattedStartDate,
        coverUrl,
      }) => (
        <a href={href ?? `/galleries/${category.slug}/${slug}`} aria-label={`Open ${title}`}>
          <Card class="card--soft is-centered is-animated" headClass="card__head--column">
            <Fragment slot="head">
              <h3 class="card__title">{title}</h3>
              {(formattedStartDate || typeof count === 'number') && (
                <div class="card__badges controls">
                  {formattedStartDate ? <span class="badge badge--small">{formattedStartDate}</span> : null}
                  {typeof count === 'number' ? (
                    <span class="badge badge--small">{count > 0 ? `${count} photos` : 'No photos yet'}</span>
                  ) : null}
                </div>
              )}
            </Fragment>
            <Fragment slot="body">
              <div class="media-album__cover" data-slug={slug}>
                {coverUrl ? (
                  <img src={coverUrl} alt="" loading="lazy" decoding="async" />
                ) : (
                  <div class="media-album__cover-placeholder" aria-hidden="true"></div>
                )}
              </div>
            </Fragment>
          </Card>
        </a>
      ))}

  </section>
