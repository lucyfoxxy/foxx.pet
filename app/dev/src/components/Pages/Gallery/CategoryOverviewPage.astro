---
interface AlbumEntry {
  slug: string;
  title: string;
  description?: string;
  href?: string;
  count?: number;
  startDate?: string;
  shareKey?: string;
  albumThumbnailAssetId?: string;
  coverUrl?: string;
}

interface CategoryInfo {
  slug: string;
  title: string;
  description?: string;
}

const { category, albums } = Astro.props as {
  category: CategoryInfo;
  albums: AlbumEntry[];
};

const dateFormatter = new Intl.DateTimeFormat('en', { month: 'short', year: 'numeric' });

const normalizedAlbums = albums.map((album) => {
  const trimmedTitle = album.title.trim();
  const parsedStartDate = album.startDate ? Date.parse(album.startDate) : Number.NaN;
  const hasValidStartDate = Number.isFinite(parsedStartDate);
  const formattedStartDate = hasValidStartDate
    ? dateFormatter.format(new Date(parsedStartDate))
    : undefined;

  const coverUrl =
    album.coverUrl ??
    (album.shareKey && album.albumThumbnailAssetId
      ? `https://img.foxx.pet/api/assets/${album.albumThumbnailAssetId}/thumbnail?key=${album.shareKey}`
      : undefined);

  return {
    ...album,
    title: trimmedTitle,
    formattedStartDate,
    coverUrl,
  };
});
---

  <section class="content-section">
    <div class="card card--plain is-centered">
    <h1>{category.title}</h1>
    {category.description ? <p>{category.description}</p> : null}
    </div>
  </section>

  <section class="content-section cols-3">
    
      {normalizedAlbums.map(({
        slug,
        title,
        description,
        href,
        count,
        formattedStartDate,
        coverUrl,
      }) => (
        <a href={href ?? `/galleries/${category.slug}/${slug}`} aria-label={`Open ${title}`}>
          <div class="card card--soft is-centered is-animated">       
            <h3>{title}</h3>
            <div class="media-album__cover" data-slug={slug}>
              {coverUrl ? (
                <img src={coverUrl} alt="" loading="lazy" decoding="async" />
              ) : (
                <div class="media-album__cover-placeholder" aria-hidden="true"></div>
              )}
            </div>

            <div class="card__badges controls">
              {formattedStartDate ? ( 
                <p class="badge badge--small"> 
                  {formattedStartDate} 
                </p> 
              ): null}
              {typeof count === 'number' ? 
                <p class="badge badge--small">
                  {count > 0 ? `${count} photos` : 'No photos yet'}
                </p>
              : null}
            </div>
          </div>           
        </a>
      ))}

  </section>
