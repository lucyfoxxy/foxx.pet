---
import { Template } from '@Frontend';
import { PLACEHOLDER_COVER, findCoverImage } from '@Assets/covers';
import {
  getPageContent,
  getNavLabelParts,
  getIntroParagraphs,
  getCategories,
  type PageContent,
} from '@Content/siteContent';

import { getCollection } from 'astro:content';
interface Props {
  slug: string;
}

const { slug } = Astro.props as Props;

let content = undefined as Awaited<ReturnType<typeof getPageContent>> | undefined;
let categories: ReturnType<typeof getCategories> = [];
let loadError: string | undefined;
const categoryCounts = new Map<string, number>();
const pathSegments = Astro.url.pathname.replace(/\/+$/, '').split('/').filter(Boolean);
const areaSegment = pathSegments[0] ?? ''; // 'album' | 'blog' | ...
if (!loadError && areaSegment === 'album') {
  const allAlbums = await getCollection('album');
  for (const entry of allAlbums) {
    const catSlug = entry.data.category?.slug;
    if (!catSlug) continue;
    categoryCounts.set(catSlug, (categoryCounts.get(catSlug) ?? 0) + 1);
  }
} else if (!loadError && areaSegment === 'blog') {
  const allPosts = await getCollection('blog');
  for (const entry of allPosts) {
    const catSlug = entry.data.category;
    if (!catSlug) continue;
    categoryCounts.set(catSlug, (categoryCounts.get(catSlug) ?? 0) + 1);
  }
}
try {
  content = await getPageContent(slug);
  categories = getCategories(content);
} catch (unknownError) {
  loadError = unknownError instanceof Error ? unknownError.message : 'Unable to load page data.';
}

const pageTitle = content?.title ?? 'Coming soon';
const meta = {
  title: pageTitle,
  description: content?.description ?? '',
};

const introParagraphs = content ? getIntroParagraphs(content) : [];
const { icon, emoji } = content ? getNavLabelParts(content) : { icon: undefined, emoji: undefined };
const placeholderCover = PLACEHOLDER_COVER;

const resolveHref = (page: PageContent | undefined, categorySlug: string, href?: string) => {
  if (href) {
    return href;
  }

  if (!page) {
    return `/${categorySlug}/`;
  }

  const normalized = page.href.replace(/\/+$/, '');
  if (!normalized) {
    return `/${categorySlug}/`;
  }

  const candidate = `${normalized}/${categorySlug}`.replace(/\/+/, '/');
  return candidate.endsWith('/') ? candidate : `${candidate}/`;
};

const normalizedCategories = !loadError && content
  ? categories.map((category) => {
      const cover = findCoverImage(category.slug, category.title) ?? placeholderCover;
      const count = categoryCounts.get(category.slug) ?? 0;
      const countLabel =
        areaSegment === 'album'
          ? 'Albums'
          : areaSegment === 'blog'
          ? 'Articles'
          : undefined;
      return {
        ...category,
        cover,
        href: resolveHref(content, category.slug, category.href),
        count,
        countLabel,
      };
    })
  : [];

const hasCategories = normalizedCategories.length > 0;
---
<Template.Base title={pageTitle} meta={meta}>
  <Template.HeaderActions slot="header__actions" href="/" label="← Home" />
  <section class="content-section">
    <Template.Card class="card--plain is-centered">
      <Fragment slot="head">
        <Template.TitleWithIcon class="card__title" title={pageTitle} icon={icon} emoji={emoji} />
      </Fragment>
      {introParagraphs.length > 0 && (
        <Fragment slot="body">
          <div class="prose">
            {introParagraphs.map((paragraph) => (
              <p>{paragraph}</p>
            ))}
          </div>
        </Fragment>
      )}
    </Card>
  </section>

  {loadError ? (
    <section class="content-section">
      <Template.Card class="card--ghost is-centered">
        <Fragment slot="body">
          <p>{loadError}</p>
        </Fragment>
      </Card>
    </section>
  ) : hasCategories ? (
    <section class="content-section cols-3">
      {normalizedCategories.map(({ slug: categorySlug, title, description, href, cover, count, countLabel}) => (
        <Template.TileView
          href={href}
          title={title}
          description={description}
          dataSlug={categorySlug}
          cover={cover.src}
          coverAlt={title}
          
          count={count}
          countLabel={countLabel}
        />
      ))}
    </section>
  ) : (
    <section class="content-section">
      <Template.Card class="card--ghost is-centered">
        <Fragment slot="body">
          <p>No categories to explore just yet — please check back soon!</p>
        </Fragment>
      </Card>
    </section>
  )}
</BaseTemplate>
