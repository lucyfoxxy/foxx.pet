---
import { Template } from '@Frontend';
import { PLACEHOLDER_COVER, findCoverImage } from '@Assets/covers';
import {
  getCategories,
  getIntroParagraphs,
  getNavLabelParts,
  getPageContent,
  type PageContent,
} from '@Content/siteContent';
import { getEntriesBySection } from '@utils/getEntries';

interface Props {
  slug: string;
}

const { slug } = Astro.props as Props;

let page: PageContent | undefined;
let loadError: string | undefined;

try {
  page = await getPageContent(slug);
} catch (unknownError) {
  const message =
    unknownError instanceof Error ? unknownError.message : 'Unable to load page data.';
  loadError = message;
}

const entries = !loadError ? await getEntriesBySection(slug) : [];
const categoryCounts = new Map<string, number>();
entries.forEach((entry) => {
  const category = typeof entry.data.category === 'string' ? entry.data.category.trim() : '';
  if (!category) return;
  categoryCounts.set(category, (categoryCounts.get(category) ?? 0) + 1);
});

const pageTitle = page?.title ?? 'Coming soon';
const pageDescription = page?.description ?? '';
const meta = { title: pageTitle, description: pageDescription };

const introParagraphs = page ? getIntroParagraphs(page) : [];
const { icon, emoji } = page ? getNavLabelParts(page) : { icon: undefined, emoji: undefined };

const categories = page ? getCategories(page) : [];

const pathSegments = Astro.url.pathname.replace(/\/+$/, '').split('/').filter(Boolean);
const areaSegment = pathSegments[0] ?? '';
const countLabel = areaSegment === 'album' ? 'Albums' : areaSegment === 'blog' ? 'Articles' : 'Entries';

const resolveHref = (pageContent: PageContent | undefined, categorySlug: string, href?: string) => {
  if (href?.trim().length) {
    return href;
  }

  if (!pageContent) {
    return `/${categorySlug}/`;
  }

  const normalized = pageContent.href.replace(/\/+$/, '');
  if (!normalized) {
    return `/${categorySlug}/`;
  }

  const candidate = `${normalized}/${categorySlug}`.replace(/\/+/, '/');
  return candidate.endsWith('/') ? candidate : `${candidate}/`;
};

const placeholderCover = PLACEHOLDER_COVER.src;

const normalizedCategories = !loadError
  ? categories
      .map((category) => {
        const categorySlug = category.slug?.trim();
        if (!categorySlug) return undefined;

        const cover =
          findCoverImage(categorySlug, category.title)?.src ?? placeholderCover;
        const href = resolveHref(page, categorySlug, category.href);
        const count = categoryCounts.get(categorySlug) ?? 0;

        return {
          ...category,
          slug: categorySlug,
          cover,
          href,
          count,
        };
      })
      .filter((value): value is NonNullable<typeof value> => Boolean(value))
  : [];

const hasCategories = normalizedCategories.length > 0;
---
<Template.Base title={pageTitle} meta={meta}>
  <Template.HeaderActions slot="header__actions" href="/" label="← Home" />

  <section class="content-section">
    <Template.Card class="card--plain is-centered">
      <Fragment slot="head">
        <Template.TitleWithIcon
          class="card__title"
          title={pageTitle}
          icon={icon}
          emoji={emoji}
        />
      </Fragment>
      {introParagraphs.length > 0 ? (
        <Fragment slot="body">
          <div class="prose">
            {introParagraphs.map((paragraph) => (
              <p>{paragraph}</p>
            ))}
          </div>
        </Fragment>
      ) : null}
    </Template.Card>
  </section>

  {loadError ? (
    <section class="content-section">
      <Template.Card class="card--ghost is-centered">
        <Fragment slot="body">
          <p>{loadError}</p>
        </Fragment>
      </Template.Card>
    </section>
  ) : hasCategories ? (
    <section class="content-section cols-3">
      {normalizedCategories.map(({ slug: categorySlug, title, description, href, cover, count }) => (
        <Template.TileView
          href={href}
          title={title}
          description={description}
          dataSlug={categorySlug}
          cover={cover}
          coverAlt={title}
          count={count}
          countLabel={countLabel}
        />
      ))}
    </section>
  ) : (
    <section class="content-section">
      <Template.Card class="card--ghost is-centered">
        <Fragment slot="body">
          <p>No categories to explore just yet — please check back soon!</p>
        </Fragment>
      </Template.Card>
    </section>
  )}
</Template.Base>
