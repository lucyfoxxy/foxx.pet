---
import { Template } from '@Frontend';
import { PLACEHOLDER_COVER } from '@Assets/covers';
import { getEntriesBySectionAndCategory, isAlbumEntry } from '@utils/getEntries';
import { getSectionBaseHref, loadSectionContext } from '@utils/sectionContext';
import {
  createAlbumEntryView,
  createBlogEntryView,
  matchesEntrySlug,
} from '@utils/entryTransforms';
import type { CollectionEntry } from 'astro:content';

interface Props {
  slug: string;
  section?: string;
  backToParentCategory?: boolean;
}

const { slug, section, backToParentCategory = false } = Astro.props as Props;

const placeholderCover = PLACEHOLDER_COVER.src;

const {
  sectionSlug,
  categorySlug,
  page: parentPage,
  category,
  error: contextError,
} = await loadSectionContext({
  url: Astro.url,
  section,
  kind: 'entry',
  missingSectionMessage: 'We could not resolve this page — please try again later.',
});

let errorMessage = contextError;

const targetCategory = categorySlug ?? slug;

const entries = !errorMessage
  ? await getEntriesBySectionAndCategory(sectionSlug, targetCategory)
  : [];

const entry = entries.find((candidate) => matchesEntrySlug(candidate, slug));

let pageTitle = parentPage?.title ?? 'Coming soon';
let pageDescription = parentPage?.description ?? '';
let metaImage: string | undefined;

const parentHref = getSectionBaseHref(sectionSlug, parentPage);
let headerBackHref = parentHref ? `${parentHref}/` : '/';
let headerBackLabel = category?.title ? `← ${category?.title}` : '← Back';

let albumView: ReturnType<typeof createAlbumEntryView>['album'] | undefined;
let blogView: ReturnType<typeof createBlogEntryView>['blog'] | undefined;

let BlogContent: Awaited<
  ReturnType<CollectionEntry<'blog'>['render']>
>['Content'] | undefined;

if (!entry && !errorMessage) {
  errorMessage = 'We could not find that entry yet. Please check back soon!';
}

if (!errorMessage && entry) {
  if (isAlbumEntry(entry)) {
    const albumData = createAlbumEntryView(entry, parentHref, {
      categorySlug,
      categoryTitle: category?.title,
      backToParentCategory,
    });
    albumView = albumData.album;
    headerBackHref = albumData.headerBackHref;
    pageTitle = albumData.pageTitle;
    pageDescription = albumData.pageDescription;
    metaImage = albumData.metaImage;
  } else {
    const rendered = await entry.render();
    BlogContent = rendered.Content;

    const blogData = createBlogEntryView(entry, parentHref, {
      categorySlug,
      categoryDescription: category?.description,
      parentPage,
      placeholderCover,
    });

    blogView = blogData.blog;
    headerBackHref = blogData.headerBackHref;
    pageTitle = blogData.pageTitle;
    pageDescription = blogData.pageDescription;
    metaImage = blogData.metaImage;
  }
}

if (errorMessage) {
  pageTitle = parentPage?.title ?? 'Content unavailable';
  pageDescription = parentPage?.description ?? '';
}

const meta = {
  title: pageTitle,
  description: pageDescription,
  ...(metaImage ? { image: metaImage } : {}),
};
---
<Template.Base title={pageTitle} meta={meta}>
  {headerBackHref && headerBackLabel ? (
    <Template.HeaderActions slot="header__actions" href={headerBackHref} label={headerBackLabel} />
  ) : null}

  {errorMessage ? (
    <section class="content-section">
      <Template.Card class=" card--center">
        <Fragment slot="body">
          <p>{errorMessage}</p>
        </Fragment>
      </Template.Card>
    </section>
  ) : albumView ? (
    <section class="content-section content-section--head">
      <Template.Card class="card--flush card--center">
        <Fragment slot="body">
          <Template.AlbumFrame album={albumView} />
        </Fragment>
      </Template.Card>

      <Template.Card class="card--flush card--center">
        <Fragment slot="body">
          <Template.AlbumThumbs />
        </Fragment>      
      </Template.Card>
    </section>
  ) : blogView ? (
    <Template.EntryBlog blog={{
      title: blogView.title,
      description: blogView.description,
      introParagraphs: blogView.introParagraphs,
      cover: blogView.cover,
      chapters: blogView.chapters,
    }} BlogContent={BlogContent} />
  ) : (
    <section class="content-section">
      <Template.Card class=" card--center">
        <Fragment slot="body">
          <p>There is nothing to display right now — please check back soon!</p>
        </Fragment>
      </Template.Card>
    </section>
  )}
</Template.Base>
<script>
  import {initGalleryFrame,initGalleryThumbs} from '@Scripts/galleryViewer.js';
  import { runOnReady } from '@Scripts/utils/_runOnReady.js';

  runOnReady(() => {
    const api = initGalleryFrame();   // Frame + Controls
    initGalleryThumbs(api);           // Thumbs-Bar (optional)
  });
</script>
