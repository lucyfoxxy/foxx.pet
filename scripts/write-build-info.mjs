// scripts/write-build-info.mjs
import { readFile, writeFile } from "node:fs/promises";
import { execSync } from "node:child_process";
import { resolve } from "node:path";

function getGitHash() {
  try {
    const hash = execSync("git rev-parse --short HEAD", {
      stdio: ["ignore", "pipe", "ignore"],
    })
      .toString()
      .trim();
    return hash || "unknown";
  } catch {
    return "unknown";
  }
}

function formatDateForId(date = new Date()) {
  const pad = (n) => String(n).padStart(2, "0");
  const year = date.getFullYear();
  const month = pad(date.getMonth() + 1);
  const day = pad(date.getDate());
  const hours = pad(date.getHours());
  const minutes = pad(date.getMinutes());
  return `${year}-${month}-${day}_${hours}${minutes}`;
}

async function main() {
  const now = new Date();
  const gitHash = getGitHash();

  const pkgJsonPath = resolve("app/package.json");
  const pkgRaw = await readFile(pkgJsonPath, "utf8");
  const pkg = JSON.parse(pkgRaw);

  // Version direkt aus package.json, mit v-PrÃ¤fix
  const version = `v${pkg.version}`;

  const timestampIso = now.toISOString();
  const timestampId = formatDateForId(now);

  const buildId = `${timestampId}-${gitHash}`;

  const buildInfo = {
    version,
    id: buildId,
    timestampIso,
    timestampId,
    gitHash,
  };

  const targetPath = resolve("app/src/generated/build-info.ts");

  const fileContent = `// AUTO-GENERATED FILE. DO NOT EDIT.
// Generated by scripts/write-build-info.mjs

export const BUILD_INFO = {
  version: ${JSON.stringify(buildInfo.version)},
  id: ${JSON.stringify(buildInfo.id)},
  timestampIso: ${JSON.stringify(buildInfo.timestampIso)},
  timestampId: ${JSON.stringify(buildInfo.timestampId)},
  gitHash: ${JSON.stringify(buildInfo.gitHash)},
} as const;

export type BuildInfo = typeof BUILD_INFO;
`;

  await writeFile(targetPath, fileContent, "utf8");

  console.log("[build-info] Wrote", targetPath);
  console.log("[build-info] BUILD_INFO =", buildInfo);
}

main().catch((err) => {
  console.error("[build-info] Failed to write build-info:", err);
  process.exit(1);
});
